# =============================================================================
# Vulnerability Management Module
# =============================================================================
#
# Configures vulnix for automated vulnerability scanning and management.
#
# What it does:
# - Installs vulnix for vulnerability scanning of installed packages
# - Integrates with NVD for up-to-date vulnerability data
# - Schedules daily automated scans via systemd timer
# - Logs results to /var/log/vulnix-scan.log
# - Provides security reports and compliance support
#
# Requirements:
# - Internet access for NVD database updates
# - Sufficient disk space for logs and database
# - Root access for comprehensive scanning
#
# Usage:
# - Import in main configuration
# - vulnix installed and available for manual scanning
# - Daily scans run automatically via systemd
# - Results logged to /var/log/vulnix-scan.log
#
# Commands:
# - vulnix --nvd /var/cache/vulnix/nvd/: Run manual vulnerability scan
# - journalctl -u vulnix-scan: View scan service logs
# - cat /var/log/vulnix-scan.log: View latest scan results
# - systemctl status vulnix-scan: Check service status
# =============================================================================

{ config, pkgs, ... }:

{
  # ============================================================================
  # Vulnerability Scanning Tools
  # ============================================================================
  # Install vulnix for vulnerability scanning and management
  # This tool provides comprehensive vulnerability assessment capabilities
  environment.systemPackages = with pkgs; [
    vulnix  # Vulnerability scanning and management tool
  ];

  # ============================================================================
  # Automated Vulnerability Scanning Service
  # ============================================================================
  # Systemd service to run vulnix vulnerability scans
  # This service performs comprehensive security assessment
  systemd.services.vulnix-scan = {
    # ========================================================================
    # Service Description
    # ========================================================================
    description = "Vulnix vulnerability scan";
    
    # ========================================================================
    # Service Configuration
    # ========================================================================
    serviceConfig = {
      Type = "oneshot";  # Run once and exit
      
      # ================================================================
      # Scan Execution
      # ================================================================
      # Execute vulnix scan with NVD database and log results
      # The scan checks for vulnerabilities in installed packages
      ExecStart = "${pkgs.vulnix}/bin/vulnix --nvd /var/cache/vulnix/nvd/ > /var/log/vulnix-scan.log 2>&1";
      
      User = "root";  # Run as root for comprehensive system access
    };
  };

  # ============================================================================
  # Automated Scanning Timer
  # ============================================================================
  # Systemd timer to trigger daily vulnerability scans
  # Ensures regular security assessment and monitoring
  systemd.timers.vulnix-scan = {
    # ========================================================================
    # Timer Description
    # ========================================================================
    description = "Daily vulnix scan";
    
    # ========================================================================
    # Timer Configuration
    # ========================================================================
    wantedBy = [ "timers.target" ];  # Enable timer on boot
    
    timerConfig = {
      OnCalendar = "daily";  # Run once per day
      Persistent = true;     # Run missed scans on boot
    };
  };
}
